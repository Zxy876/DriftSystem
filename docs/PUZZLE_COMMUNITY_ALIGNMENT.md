# “猜谜解谜共同体”落地路径

## 愿景概述
玩家带着问题进入世界，通过探索、对话、观察环境逐步收集线索；CityPhone 和 StoryState 将线索结构化并反馈缺口，促使玩家自然做出决策，最终达成建造或剧情目标。目标是在不扩充大功能模块的前提下，把现有系统（故事模板、CityPhone、Build Pipeline、模板 YAML、执行回路）打通为一个连续、易理解的“提问→解谜→实践→建造”体验。

## 指导原则
- **使用现有能力**：优先利用已有的 StoryState 模板、里程碑、CityPhone UI、BuildPlan/Executor；仅做胶合层与配置调整。
- **线索即模板字段**：将谜题线索映射到已存在的模板字段（资源、约束、风险等），避免新增数据结构。
- **问题驱动循环**：玩家的提问或困惑应直接映射到 CityPhone 的缺口提示，并驱动下一步行动。
- **逐步解锁**：让模板/里程碑按线索顺序释放，避免一次性补齐导致体验跳过。
- **可度量**：通过日志/StoryState 版本追踪玩家完成每步所用时间与提示次数。

## 阶段化步骤
### 阶段 0：现状对齐（文档+配置）
1. 盘点已有模板 YAML，标注哪些字段代表“线索”“关键条件”“答案验证”。
2. 在 `docs/STORYSTATE_TEMPLATE_ROADMAP.md` 中补充每个模板的线索顺序与来源 NPC。
3. 调整 CityPhone 文案，使“未完成字段”以提问式语言呈现（例如“还不知道谁能提供夜间灯光”）。

### 阶段 1：问题→线索映射
1. 在 `story_templates.yaml` 中为每条线索设定 `hint_trigger`（可重用现有 `notes`/`coverage_tags`），指向可触发的 NPC/场景。
2. 更新 `world_api.story_rule_event` 中的里程碑笔记拼接逻辑，让其将对应线索写入 `StoryState.notes`。
3. CityPhone “任务”页读取 `notes`，以卡片形式展示“当前线索”（无需新界面，只改文案/排序）。

### 阶段 2：线索→决策
1. StoryStateAgent 在合并 patch 时，根据缺失字段生成提问式 follow-up（沿用 `follow_up_questions`）。
2. 玩家提问时（`parse_intent` 识别“怎么办/怎么找到”），优先返回 CityPhone 中缺失字段的提示。
3. 当线索齐备（字段补齐），CityPhone 自动突出“可执行方案”按钮，提示玩家发起建造。

### 阶段 3：决策→建造执行
1. 继续使用现有 `/drift build` 流程；确保 BuildPlan 摘要引用已完成线索（在 `build_plan.summary` 拼入关键字段）。
2. 失败时启用 `BUILD_FAILURE_FEEDBACK_LOOP.md` 中的流程，将缺失线索重新写回 CityPhone。
3. 成功执行后，在 CityPhone 追加“你如何解决了问题”的回顾文本（使用 BuildExecutor 日志 + StoryState.delta）。

### 阶段 4：体验验证与调优
1. 设计至少两个“谜题”示例剧本（一个资源型、一个约束型），写入 `docs/PUZZLE_CASE_STUDIES.md`（待创建）。
2. 观察玩家完成每个线索的平均对话次数，调节提示强度或 NPC 文案。
3. 收集玩家反馈，更新模板 YAML 和 CityPhone 文案，使提示更符合“共同体协作”语气。

## 实施清单
- [ ] 在 `STORYSTATE_TEMPLATE_ROADMAP.md` 标注现有模板的线索顺序与负责 NPC。
- [ ] 为模板 YAML 中的关键字段添加 `hint_trigger` 或备注。
- [ ] 调整 CityPhone 文案，确保缺口以问题陈述方式出现。
- [ ] StoryStateAgent 增强：若存在缺口且玩家询问，返回对应线索提示。
- [ ] World API 将任务完成记录的线索写入 `StoryState.notes` 并显示在 CityPhone。
- [ ] BuildPlan 摘要引用线索字段，成功/失败都输出“我们如何解决/障碍是什么”。
- [ ] 根据两套示例谜题跑端到端测试，确认提问→解谜→建造循环顺畅。

## 验收指标
- 玩家从首次提问到完成建造的交互回合数 ≤ 5。
- CityPhone 未完成字段全部以提问语气呈现，且在完成后自动转为回顾语气。
- 至少两个示例谜题在不新增代码模块的基础上运行成功。
- 日志中记录问题关键词与线索触发之间的关联事件（用于后续分析）。

## 后续维护建议
- 每新增模板/谜题，先更新文档与 YAML 的线索顺序，再配置 NPC/任务脚本。
- 定期回放玩家日志，确保提问→线索提示的覆盖率保持高水平。
- 若未来需要强化协作，可在此基础上再引入多玩家共享线索、投票决策等扩展，但不作为当前阶段目标。
