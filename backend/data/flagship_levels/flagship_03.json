{
  "id": "flagship_03",
  "title": "旗舰关卡 · 风暴之山",
  "tags": ["旗舰", "登山", "心理", "心象", "恐惧"],
  "meta": {
    "chapter": 3,
    "word_count": 0,
    "difficulty": "medium",
    "theme": "mountain_storm",
    "flagship": true
  },

  "memory_affinity": ["xinyue.admitted_pain", "xinyue.masked_pain"],

  "scene": {
    "world": "KunmingLakeStory",
    "teleport": { "x": 12.5, "y": 68, "z": -34.5, "yaw": -10, "pitch": 12 },
    "environment": { "weather": "SNOW", "time": "DUSK" },
    "structures": [
      "structures/mountain/base_camp_v2.nbt",
      "structures/mountain/mid_camp_v2.nbt",
      "structures/mountain/summit_gate.nbt"
    ],
    "npc_skins": [
      { "id": "Climber", "skin": "skins/climber_summit.png" },
      { "id": "FearShadow", "skin": "skins/fear_shadow.png" }
    ]
  },

  "world_patch": {
    "mc": {
      "spawn": {
        "type": "player_like",
        "name": "登山者",
        "offset": { "dx": 1, "dy": 0, "dz": -2 },
        "behaviors": [
          {
            "type": "patrol",
            "path": [
              {"dx": 0, "dz": 0},
              {"dx": 2, "dz": 2},
              {"dx": -2, "dz": 2}
            ],
            "speed": 0.7,
            "description": "在营地检查风绳和补给"
          },
          {
            "type": "interact",
            "trigger": "right_click",
            "action": "dialogue",
            "messages": [
              "§6[登山者]§r 山不会等你，但你可以准备好。",
              "§6[登山者]§r 想继续前进，说一句：'我准备好了。'"
            ]
          }
        ],
        "ai_hints": "登山者会根据玩家恐惧值动态调整对话语气。"
      },
      "_scene": {
        "level_id": "flagship_03",
        "title": "风暴之山",
        "theme": "mountain_storm",
        "scene_world": "KunmingLakeStory",
        "teleport": { "x": 12.5, "y": 68, "z": -34.5, "yaw": -10, "pitch": 12 }
      }
    },
    "variables": {
      "fear": 0.2,
      "breath": 1.0,
      "unlocked": true
    }
  },

  "narrative": {
    "text": [
      "空气像被风切碎，雪的尖刺敲打面颊。",
      "你感觉到胸腔在收缩——不是寒冷，是某种更深的东西。",
      "登山者看着你，仿佛知道你要面对的不是山峰，而是你自己的影子。"
    ],
    "beats": [
      {
        "id": "flag_03_intro_comfort",
        "trigger": "on_enter",
        "scene_patch": "scene_base_camp_cinematic",
        "rule_refs": ["intro_calm"],
        "memory_required": ["xinyue.admitted_pain"],
        "world_patch": {
          "mc": {
            "tell": "§b[登山者]§r 今天风不算狠，我们可以慢慢走。",
            "particle": {"type": "snowflake", "count": 18},
            "sound": {"type": "MUSIC_DISC_CHIRP", "volume": 0.6, "pitch": 1.05}
          }
        },
        "choices": [
          {
            "id": "intro_ready_gentle",
            "text": "深呼吸：我想试着往上。",
            "rule_event": "ready_to_climb",
            "tags": ["supported", "brave"]
          },
          {
            "id": "intro_share_weight",
            "text": "先和你说说心里的重物。",
            "rule_event": "hesitation",
            "tags": ["processing", "hesitant"]
          }
        ]
      },
      {
        "id": "flag_03_intro",
        "trigger": "on_enter",
        "rule_refs": ["intro_calm"],
        "memory_required": ["xinyue.masked_pain"],
        "scene_patch": "scene_base_camp_cinematic",
        "world_patch": {
          "mc": {
            "tell": "§6[登山者]§r 山不会给我们太多休息，先试着跟上我的节奏。",
            "particle": {"type": "snowball", "count": 12},
            "sound": {"type": "ENTITY_WOLF_GROWL", "volume": 0.5, "pitch": 1.1}
          }
        },
        "choices": [
          {
            "id": "intro_ready",
            "text": "我准备好了。",
            "rule_event": "ready_to_climb",
            "tags": ["brave"]
          },
          {
            "id": "intro_hesitate",
            "text": "我……还不确定。",
            "rule_event": "hesitation",
            "tags": ["hesitant"]
          }
        ]
      },

      {
        "id": "flag_03_ascent",
        "trigger": "rule_event:ready_to_climb",
        "scene_patch": "scene_mid_camp_fog",
        "rule_refs": ["fear_pulse"],
        "choices": [
          {
            "id": "push_fog",
            "text": "继续前进（抵抗迷雾）",
            "rule_event": "push_forward",
            "tags": ["brave"]
          },
          {
            "id": "fall_back",
            "text": "退后一步（心跳加速）",
            "rule_event": "fear_gain",
            "tags": ["fear"]
          }
        ]
      },

      {
        "id": "flag_03_summit",
        "trigger": ["rule_event:push_forward", "rule_event:overcome_fear"],
        "scene_patch": "scene_summit_arrival",
        "rule_refs": ["summit_view"],
        "memory_set": ["xinyue.reached_summit"]
      }
    ]
  },

  "rules": {
    "listeners": [
      {
        "id": "intro_calm",
        "type": "quest_event",
        "targets": ["base_camp"],
        "quest_event": "intro_calm",
        "metadata": {
          "update_behaviors": [
            { "type": "particle", "particle": "snowflake", "description": "轻雪飘过" }
          ]
        }
      },
      {
        "id": "fear_pulse",
        "type": "quest_event",
        "targets": ["fog_zone"],
        "quest_event": "fear_tick",
        "metadata": {
          "dialogue": [
            "§7风声中似乎混入了你的心跳……",
            "§8[幻象]§r   你为什么还要往上走？"
          ],
          "update_behaviors": [
            { "type": "particle", "particle": "smoke", "description": "迷雾脉冲" }
          ]
        }
      },
      {
        "id": "summit_view",
        "type": "quest_event",
        "targets": ["summit_portal"],
        "quest_event": "summit_view",
        "metadata": {
          "commands": [
            "title @p title {\"text\":\"风暴之巅\",\"color\":\"aqua\"}",
            "playsound minecraft:music.game credits @p ~ ~ ~ 1 1"
          ]
        }
      }
    ]
  },

  "tasks": [
    {
      "id": "flag_03_climb_progress",
      "type": "exploration",
      "conditions": [
        { "location": "base_camp", "count": 1 },
        { "location": "mid_camp", "count": 1 },
        { "location": "summit_portal", "count": 1 }
      ],
      "milestones": ["reached_mid", "reached_summit"],
      "rewards": [
        { "type": "xp", "amount": 200 },
        { "type": "item", "amount": 1, "data": { "id": "summit_token" } }
      ]
    }
  ],

  "exit": {
    "phrase_aliases": ["结束剧情", "离开关卡", "返回营地"],
    "return_spawn": "KunmingLakeHub",
    "teleport": { "x": 0.5, "y": 70, "z": 0.5, "yaw": 0, "pitch": 0 }
  }
}